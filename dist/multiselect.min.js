angular.module("oi.multiselect",[]),angular.module("oi.multiselect").provider("oiMultiselect",function(){return{options:{debounce:500,searchFilter:"oiMultiselectCloseIcon",dropdownFilter:"oiMultiselectHighlight",listFilter:"oiMultiselectAscSort",saveLastQuery:null,newItem:!1,saveTrigger:"enter, backslash"},$get:function(){return{options:this.options}}}}).factory("oiUtils",["$document",function(a){function b(b,d){var e=angular.element("<mirror>").css({position:"absolute",width:"auto",padding:0,whiteSpace:"pre",visibility:"hidden","z-index":-99999}).text(b||"");c(d,e,"letterSpacing fontSize fontFamily fontWeight textTransform".split(" ")),a[0].body.appendChild(e[0]);var f=e[0].offsetWidth;return e.remove(),f}function c(a,b,c){for(var d={},e=getComputedStyle(a[0],""),f=0,g=c.length;g>f;f++)d[c[f]]=e[c[f]];b.css(d)}function d(a,b){var c,d,e,g,i,j;b&&(d=a.offsetHeight,e=h(b,"height","margin"),g=a.scrollTop||0,c=f(b).top-f(a).top+g,i=c,j=c-d+e,c+e>d+g?a.scrollTop=j:g>c&&(a.scrollTop=i))}function e(a,b,c,d,e){function f(a){return parseFloat(e[a])}for(var g=c===(d?"border":"content")?4:"width"===b?1:0,h=0,i=["Top","Right","Bottom","Left"];4>g;g+=2)"margin"===c&&(h+=f(c+i[g])),d?("content"===c&&(h-=f("padding"+i[g])),"margin"!==c&&(h-=f("border"+i[g]+"Width"))):(h+=f("padding"+i[g]),"padding"!==c&&(h+=f("border"+i[g]+"Width")));return h}function f(a){var b,c,d=a.getBoundingClientRect(),e=a&&a.ownerDocument;if(e)return b=e.documentElement,c=g(e),{top:d.top+c.pageYOffset-b.clientTop,left:d.left+c.pageXOffset-b.clientLeft}}function g(a){return null!=a&&a===a.window?a:9===a.nodeType&&a.defaultView}function h(a,b,c){var d=!0,f="width"===b?a.offsetWidth:a.offsetHeight,g=window.getComputedStyle(a,null),h=!1;if(0>=f||null==f){if(f=g[b],(0>f||null==f)&&(f=a.style[b]),p.test(f))return f;f=parseFloat(f)||0}return f+e(a,b,c||(h?"border":"content"),d,g)}function i(a,b){b.css("width",h(a[0],"width","margin")+"px")}function j(a){for(var b in a)if(a.hasOwnProperty(b)&&a[b].length)return!1;return!0}function k(a){var b=[];return angular.forEach(a,function(a,c){"$"!==c.toString().charAt(0)&&b.push(a)}),b}function l(a,b){if(a===b)return!0;if(!(a instanceof Object&&b instanceof Object))return!1;if(a.constructor!==b.constructor)return!1;for(var c in a)if(a.hasOwnProperty(c)){if(!b.hasOwnProperty(c))return!1;if(a[c]!==b[c]){if("object"!=typeof a[c])return!1;if(!objectEquals(a[c],b[c]))return!1}}for(c in b)if(b.hasOwnProperty(c)&&!a.hasOwnProperty(c))return!1;return!0}function m(a,b,c,d,e,f){var g,h,i,j,k,l=f?[].concat(a):[];for(c=c||function(a,b){return a===b},g=0,i=a.length;g<a.length;g++)for(j=d?d(a[g]):a[g],h=0;h<b.length;h++)if(k=e?e(b[h]):b[h],c(j,k,a,b,g,h)){f?l.splice(g+l.length-i,1):l.push(a[g]);break}return l}function n(a,b,c,d){var e={};return a.split(".").reduce(function(a,c,d,e){return a[c]=d<e.length-1?{}:b},e),d(c,e)}var o=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,p=new RegExp("^("+o+")(?!px)[a-z%]+$","i");return{copyWidth:i,measureString:b,scrollActiveOption:d,groupsIsEmpty:j,objToArr:k,getValue:n,isEqual:l,intersection:m}}]),angular.module("oi.multiselect").directive("oiMultiselect",["$document","$q","$timeout","$parse","$interpolate","$injector","$filter","oiUtils","oiMultiselect",function(a,b,c,d,e,f,g,h,i){var j=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+group\s+by\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+([\s\S]+?)(?:\s+track\s+by\s+([\s\S]+?))?$/,k=/([^\(\)\s\|\s]*)\s*(\(.*\))?\s*(\|?\s*.+)?/;return{restrict:"AE",templateUrl:"template/multiselect/template.html",require:"ngModel",scope:{},compile:function(l,m){var n,o=m.oiOptions;if(!(n=o.match(j)))throw new Error("Expected expression in form of '_select_ (as _label_)? for (_key_,)?_value_ in _collection_'");var p,q,r=/ as /.test(n[0])&&n[1],s=n[2]||n[1],t=n[4]||n[6],u=n[3]||"",v=n[8]||s,w=n[7].match(k),x=w[1],y=x+(w[3]||""),z=x+(w[2]||""),A=r&&d(r),B=d(s),C=d(u),D=d(y),E=d(z),F=d(v),G=angular.isDefined(m.multiple),H=Number(m.multipleLimit),I=e(m.placeholder||""),J=!1,K=!1,L=d(m.oiMultiselectOptions);return function(d,e,j,k){function l(a){var e=new RegExp(a).test(R.saveTrigger),f=R.newItem&&d.query,g=angular.isNumber(d.selectorPosition),h=d.order[d.selectorPosition],i=R.newItemFn||R.newItemModelFn,j=b.reject();e&&(f||g&&h)&&(d.showLoader=!0,j=b.when("blur"!==a&&h||d.query&&i(d.query))),j.then(d.addItem)["finally"](function(){var a=d.order.length-1;d.selectorPosition===a&&M(P,0),R.newItemFn&&!g||c(angular.noop),z()})}function m(b){b&&b.target.ownerDocument.activeElement===O[0]||(c(function(){e.triggerHandler("blur")}),l("blur"),a.off("click",m),d.isFocused=!1,d.$evalAsync())}function n(){var a=k.$modelValue&&k.$modelValue.length?"":Q;O.attr("placeholder",a),d.inputWidth=h.measureString(d.query||a,O)+4}function o(a){return h.getValue(t,a,d,F)}function r(a){return h.getValue(t,a,d,A)}function s(a){return h.getValue(t,a,d,B)}function u(a){return h.getValue(t,a,d,C)||""}function v(a){return h.getValue(x,a,d.$parent,D)}function w(a,e){var f=E(d.$parent,{$query:a,$querySelectAs:e}),i=0;return d.selectorPosition="prompt"===R.newItem?!1:0,a||e||(d.oldQuery=null),p&&(angular.isFunction(f.then)||angular.isFunction(f.$promise))&&(c.cancel(p),i=R.debounce),p=c(function(){return d.showLoader=!0,b.when(f.$promise||f).then(function(b){if(!e){var c=g(R.listFilter)(h.objToArr(b),a,s),f=h.intersection(c,d.output,h.isEqual,o,o,!0),i=v(f);d.groups=N(i),y()}return b})["finally"](function(){d.showLoader=!1})},i)}function y(){var a,b,c,e=[],f=0;d.order=[],d.groupPos={};for(b in d.groups)d.groups.hasOwnProperty(b)&&"$"!=b.charAt(0)&&e.push(b);for(e.sort(),a=0;a<e.length;a++)b=e[a],c=d.groups[b],d.order=d.order.concat(c),d.groupPos[b]=f,f+=c.length}function z(){d.oldQuery=null,d.backspaceFocus=!1,d.query="",d.groups={},d.order=[],d.showLoader=!1,d.isOpen=!1,p&&c.cancel(p)}function M(a,b){d.selectorPosition=b,h.scrollActiveOption(a[0],a.find("li")[b])}function N(a){for(var b,c,d={"":[]},e=0;e<a.length;e++)b=u(a[e]),(c=d[b])||(c=d[b]=[]),c.push(a[e]);return d}var O=e.find("input"),P=angular.element(e[0].querySelector(".multiselect-dropdown")),Q=I(d),R=angular.extend({},i.options,L(d.$parent)),S=R.saveLastQuery?f.get(R.saveLastQuery):function(){return""};R.newItemModelFn=function(a){return(L({$query:a})||{}).newItemModel||a},angular.isDefined(j.autofocus)&&c(function(){O[0].focus()}),angular.isDefined(j.readonly)&&O.attr("readonly",!0),j.$observe("disabled",function(a){O.prop("disabled",a)}),d.$parent.$watch(j.ngModel,function(a){n();var c=a instanceof Array?a:a?[a]:[],e=b.when(c);A&&a&&(e=w(null,a).then(function(a){return h.intersection(a,c,h.isEqual,r)}),p=null),e.then(function(a){d.output=a,a.length!==c.length&&d.removeItem(a.length)})}),d.$watch("query",function(a,b){n(),a===b||d.oldQuery&&!a||K||(P[0].scrollTop=0,a?(w(a),d.oldQuery=null):(z(),K=!0)),K=!1}),d.$watch("groups",function(a){h.groupsIsEmpty(a)?d.isOpen=!1:d.isOpen||j.disabled||(d.isOpen=!0,d.isFocused=!0,h.copyWidth(e,P))}),d.$watch("isFocused",function(b){b&&(e.triggerHandler("focus"),a.on("click",m))}),d.setFocus=function(a){return j.disabled?void 0:(d.backspaceFocus=!1,"INPUT"!==a.target.nodeName&&O[0].focus(),"focus"!==a.type||d.isOpen||d.isFocused?void("click"===a.type&&angular.element(a.target).scope()===this&&(d.isOpen&&!d.query?z():w(d.query))):void(d.isFocused=!0))},d.addItem=function(a){if(q=d.query,!(h.intersection(d.output,[a],null,o,o).length||!isNaN(H)&&d.output.length>=H)){var b=d.groups[u(a)],c=A?r(a):a;b.splice(b.indexOf(a),1),G?(k.$setViewValue(angular.isArray(k.$modelValue)?k.$modelValue.concat(c):[c]),y()):(k.$setViewValue(c),z()),h.groupsIsEmpty(d.groups)&&(d.groups={}),d.oldQuery=d.oldQuery||d.query,d.query="",d.backspaceFocus=!1,n()}},d.removeItem=function(a){var b;j.disabled||(G&&a>=0?(b=k.$modelValue[a],k.$modelValue.splice(a,1),k.$setViewValue([].concat(k.$modelValue))):angular.isDefined(j.notempty)||(b=k.$modelValue,k.$setViewValue(void 0)),d.query=S(b,q),(d.isOpen||d.oldQuery||!G)&&w(d.oldQuery),n())},d.setSelection=function(a){J||d.selectorPosition===a?J=!1:M(P,a)},d.keyParser=function(a){var b=0,c=d.order.length-1;switch(a.keyCode){case 38:d.selectorPosition=angular.isNumber(d.selectorPosition)?d.selectorPosition:b,M(P,d.selectorPosition===b?c:d.selectorPosition-1),J=!0;break;case 40:d.selectorPosition=angular.isNumber(d.selectorPosition)?d.selectorPosition:b-1,M(P,d.selectorPosition===c?b:d.selectorPosition+1),J=!0,d.query.length||d.isOpen||w();break;case 37:case 39:break;case 13:l("enter");break;case 9:m();break;case 220:l("backslash"),a.preventDefault();break;case 27:z();break;case 8:if(!d.query.length){if(d.backspaceFocus&&d.output&&(d.removeItem(d.output.length-1),!d.output.length)){w();break}d.backspaceFocus=!d.backspaceFocus;break}default:return d.backspaceFocus=!1,!1}},d.getSearchLabel=function(a){var b=s(a);return R.searchFilter&&(b=g(R.searchFilter)(b,d.oldQuery||d.query,a)),b},d.getDropdownLabel=function(a){var b=s(a);return R.dropdownFilter&&(b=g(R.dropdownFilter)(b,d.oldQuery||d.query,a)),b},G&&(k.$isEmpty=function(a){return!a||!a.length}),z()}}}}]),angular.module("oi.multiselect").filter("oiMultiselectCloseIcon",["$sce",function(a){return function(b){var c='<span class="close multiselect-search-list-item_selection-remove">Ã—</span>';return a.trustAsHtml(b+c)}}]).filter("oiMultiselectHighlight",["$sce",function(a){return function(b,c){var d;return c.length>0||angular.isNumber(c)?(b=b.toString(),c=c.toString(),d=b.replace(new RegExp(c,"gi"),"<strong>$&</strong>")):d=b,a.trustAsHtml(d)}}]).filter("oiMultiselectAscSort",function(){function a(a,b,c){var d,e,f=[],g=[],h=[];if(b){for(d=0;d<a.length;d++)c(a[d]).match(new RegExp(b,"i"))&&f.push(a[d]);for(d=0;d<f.length;d++)c(f[d]).match(new RegExp("^"+b,"i"))?g.push(f[d]):h.push(f[d]);e=g.concat(h)}else e=[].concat(a);return e}return a});