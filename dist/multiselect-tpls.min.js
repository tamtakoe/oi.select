angular.module("oi.multiselect",["template/multiselect/template.html"]),angular.module("template/multiselect/template.html",[]).run(["$templateCache",function(a){a.put("template/multiselect/template.html",'<div class="multiselect-search" ng-class="{open: isOpen, focused: isFocused, loading: showLoader}" ng-click="setFocus($event)">\n    <ul class="multiselect-search-list">\n        <li class="btn btn-default btn-xs multiselect-search-list-item multiselect-search-list-item_selection"\n            ng-repeat="item in output track by $index"\n            ng-class="{focused: backspaceFocus && $last}"\n            ng-click="removeItem($index)"\n            ng-bind-html="getSearchLabel(item)"></li>\n        <li class="multiselect-search-list-item multiselect-search-list-item_input"><input autocomplete="off"\n                                                                                           ng-model="query"\n                                                                                           ng-style="{\'width\': inputWidth + \'px\'}"\n                                                                                           ng-keydown="keyParser($event)"/></li>\n        <li class="multiselect-search-list-item multiselect-search-list-item_loader" ng-show="showLoader"></li>\n    </ul>\n</div>\n<div class="multiselect-dropdown" ng-show="isOpen" ng-click="setFocus($event)">\n    <ul ng-if="isOpen" class="multiselect-dropdown-optgroup" ng-repeat="(group, options) in groups">\n        <div class="multiselect-dropdown-optgroup-header"\n            ng-if="group && options.length"\n            ng-bind="group"></div><!-- we use fast getElementsByTagName(\'li\')-->\n        <li class="multiselect-dropdown-optgroup-option"\n            ng-repeat="option in options"\n            ng-class="{\'active\': selectorPosition === groupPos[group] + $index}"\n            ng-click="addItem(option)"\n            ng-mouseenter="setSelection(groupPos[group] + $index)"\n            ng-bind-html="getDropdownLabel(option)"></li>\n    </ul>\n</div>')}]),angular.module("oi.multiselect").provider("oiMultiselect",function(){return{options:{debounce:500,searchFilter:"oiMultiselectCloseIcon",dropdownFilter:"oiMultiselectHighlight",listFilter:"oiMultiselectAscSort",saveLastQuery:null},$get:function(){return{options:this.options}}}}).factory("oiUtils",["$document",function(a){function b(b,d){var e=angular.element("<mirror>").css({position:"absolute",width:"auto",padding:0,whiteSpace:"pre",visibility:"hidden","z-index":-99999}).text(b||"");c(d,e,"letterSpacing fontSize fontFamily fontWeight textTransform".split(" ")),a[0].body.appendChild(e[0]);var f=e[0].offsetWidth;return e.remove(),f}function c(a,b,c){for(var d={},e=getComputedStyle(a[0],""),f=0,g=c.length;g>f;f++)d[c[f]]=e[c[f]];b.css(d)}function d(a,b){var c,d,e,g,i,j;b&&(d=a.offsetHeight,e=h(b,"height","margin"),g=a.scrollTop||0,c=f(b).top-f(a).top+g,i=c,j=c-d+e,c+e>d+g?a.scrollTop=j:g>c&&(a.scrollTop=i))}function e(a,b,c,d,e){function f(a){return parseFloat(e[a])}for(var g=c===(d?"border":"content")?4:"width"===b?1:0,h=0,i=["Top","Right","Bottom","Left"];4>g;g+=2)"margin"===c&&(h+=f(c+i[g])),d?("content"===c&&(h-=f("padding"+i[g])),"margin"!==c&&(h-=f("border"+i[g]+"Width"))):(h+=f("padding"+i[g]),"padding"!==c&&(h+=f("border"+i[g]+"Width")));return h}function f(a){var b,c,d=a.getBoundingClientRect(),e=a&&a.ownerDocument;if(e)return b=e.documentElement,c=g(e),{top:d.top+c.pageYOffset-b.clientTop,left:d.left+c.pageXOffset-b.clientLeft}}function g(a){return null!=a&&a===a.window?a:9===a.nodeType&&a.defaultView}function h(a,b,c){var d=!0,f="width"===b?a.offsetWidth:a.offsetHeight,g=window.getComputedStyle(a,null),h=!1;if(0>=f||null==f){if(f=g[b],(0>f||null==f)&&(f=a.style[b]),m.test(f))return f;f=parseFloat(f)||0}return f+e(a,b,c||(h?"border":"content"),d,g)}function i(a,b){b.css("width",h(a[0],"width","margin")+"px")}function j(a){for(var b in a)if(a.hasOwnProperty(b)&&a[b].length)return!1;return!0}function k(a){var b=[];return angular.forEach(a,function(a){b.push(a)}),b}var l=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,m=new RegExp("^("+l+")(?!px)[a-z%]+$","i");return{copyWidth:i,measureString:b,scrollActiveOption:d,groupsIsEmpty:j,objToArr:k}}]),angular.module("oi.multiselect").directive("oiMultiselect",["$document","$q","$timeout","$parse","$interpolate","$injector","$filter","oiUtils","oiMultiselect",function(a,b,c,d,e,f,g,h,i){var j=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+group\s+by\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+([\s\S]+?)(?:\s+track\s+by\s+([\s\S]+?))?$/,k=/([^\(\)\s\|\s]*)\s*(\(.*\))?\s*(\|?\s*.+)?/;return{restrict:"AE",templateUrl:"template/multiselect/template.html",require:"ngModel",scope:{},compile:function(l,m){var n,o=m.ngOptions;if(!(n=o.match(j)))throw new Error("Expected expression in form of '_select_ (as _label_)? for (_key_,)?_value_ in _collection_'");var p,q,r=n[2]||n[1],s=n[4]||n[6],t=n[3]||"",u=n[8]||r,v=n[7].match(k),w=v[1],x=w+(v[3]||""),y=w+(v[2]||""),z=d(r),A=d(t),B=d(x),C=d(y),D=d(u),E={},F=angular.isDefined(m.multiple),G=Number(m.multipleLimit),H=e(m.placeholder||""),I=d(m.oiMultiselectOptions),J=!1,K=!1;return function(d,e,j,k){function l(b){b.target.ownerDocument.activeElement!==O[0]&&(L(),a.off("click",l),d.isFocused=!1,d.$digest())}function m(){var a=k.$modelValue&&k.$modelValue.length?"":Q;O.attr("placeholder",a),d.inputWidth=h.measureString(d.query||a,O)+4}function n(a){return E={},E[s]=a,D(d,E)}function o(a){return E={},w.split(".").reduce(function(b,c,d,e){return b[c]=d<e.length-1?{}:a},E),B(d.$parent,E)}function r(a){return E={},E[s]=a,z(d,E)}function t(a){return E={},E[s]=a,A(d,E)||""}function u(a){var e=C(d.$parent,{$query:a}),f=0;d.selectorPosition=0,a||(d.oldQuery=null),p&&angular.isFunction(e.then)&&(c.cancel(p),f=R.debounce),p=c(function(){d.showLoader=!0,b.when(e).then(function(b){d.groups=N(o(x(g(R.listFilter)(v(b),a,r)))),y()}).finally(function(){d.showLoader=!1})},f)}function v(a){var b=angular.isArray(a)?a:h.objToArr(a);return[].concat(b)}function x(a){var b,c,e=[].concat(d.output);for(b=0;b<a.length;b++)for(c=0;c<e.length;c++)if(n(a[b])===n(e[c])){a.splice(b,1),e.splice(c,1),b--;break}return a}function y(){var a,b,c,e=[],f=0;d.order=[],d.groupPos={};for(b in d.groups)d.groups.hasOwnProperty(b)&&"$"!=b.charAt(0)&&e.push(b);for(e.sort(),a=0;a<e.length;a++)b=e[a],c=d.groups[b],d.order=d.order.concat(c),d.groupPos[b]=f,f+=c.length}function L(){d.oldQuery=null,d.backspaceFocus=!1,d.query="",d.groups={},d.order=[],d.showLoader=!1,d.isOpen=!1,p&&c.cancel(p)}function M(a,b){d.selectorPosition=b,h.scrollActiveOption(a[0],a.find("li")[b])}function N(a){for(var b,c,d={"":[]},e=0;e<a.length;e++)b=t(a[e]),(c=d[b])||(c=d[b]=[]),c.push(a[e]);return d}var O=e.find("input"),P=angular.element(e[0].querySelector(".multiselect-dropdown")),Q=H(d),R=angular.extend({},i.options,I(d));angular.isDefined(j.autofocus)&&c(function(){O[0].focus()}),angular.isDefined(j.readonly)&&O.attr("readonly",!0),j.$observe("disabled",function(a){O.prop("disabled",a)}),d.$parent.$watch(j.ngModel,function(a){m(),d.output=F?a:a?[a]:[]}),d.$watch("query",function(a,b){m(),a===b||d.oldQuery&&!a||K||(P[0].scrollTop=0,a?(u(a),d.oldQuery=null):(L(),K=!0)),K=!1}),d.$watch("groups",function(b){h.groupsIsEmpty(b)?d.isOpen=!1:d.isOpen||j.disabled||(d.isOpen=!0,h.copyWidth(e,P),d.isFocused||(a.on("click",l),d.isFocused=!0))}),d.setFocus=function(a){j.disabled||(angular.element(a.target).scope()===this&&(d.isOpen?L():u(d.query)),d.backspaceFocus=!1,"INPUT"!==a.target.nodeName&&O[0].focus())},d.addItem=function(a){if(q=d.query,isNaN(G)||!(d.output.length>=G)){var b=d.groups[t(a)];b.splice(b.indexOf(a),1),F?(k.$setViewValue(angular.isArray(k.$modelValue)?k.$modelValue.concat(a):[a]),y()):(k.$setViewValue(a),L()),h.groupsIsEmpty(d.groups)&&(d.groups={}),d.oldQuery=d.oldQuery||d.query,d.query="",d.backspaceFocus=!1,m()}},d.removeItem=function(a){var b;j.disabled||(F?(b=k.$modelValue[a],k.$modelValue.splice(a,1),k.$setViewValue([].concat(k.$modelValue))):angular.isDefined(j.notempty)||(b=k.$modelValue,k.$setViewValue(void 0)),d.query=R.saveLastQuery?f.get(R.saveLastQuery)(b,q):"",(d.isOpen||d.oldQuery||!F)&&u(d.oldQuery),m())},d.setSelection=function(a){J||d.selectorPosition===a?J=!1:M(P,a)},d.keyParser=function(a){var b=0,c=d.order.length-1;switch(a.keyCode){case 38:M(P,d.selectorPosition===b?c:d.selectorPosition-1),J=!0;break;case 40:M(P,d.selectorPosition===c?b:d.selectorPosition+1),J=!0,d.query.length||d.isOpen||u();break;case 37:case 39:break;case 13:h.groupsIsEmpty(d.groups)||(d.addItem(d.order[d.selectorPosition]),d.selectorPosition===c&&M(P,0));break;case 27:L();break;case 8:if(!d.query.length){if(d.backspaceFocus&&d.output&&(d.removeItem(d.output.length-1),!d.output.length)){u();break}d.backspaceFocus=!d.backspaceFocus;break}default:return d.backspaceFocus=!1,!1}},d.getSearchLabel=function(a){var b=r(a);return R.searchFilter&&(b=g(R.searchFilter)(b,d.oldQuery||d.query,a)),b},d.getDropdownLabel=function(a){var b=r(a);return R.dropdownFilter&&(b=g(R.dropdownFilter)(b,d.oldQuery||d.query,a)),b},F&&(k.$isEmpty=function(a){return!a||!a.length}),L()}}}}]),angular.module("oi.multiselect").filter("oiMultiselectCloseIcon",["$sce",function(a){return function(b){var c='<span class="close multiselect-search-list-item_selection-remove">Ã—</span>';return a.trustAsHtml(b+c)}}]).filter("oiMultiselectHighlight",["$sce",function(a){return function(b,c){var d;return c.length>0||angular.isNumber(c)?(b=b.toString(),c=c.toString(),d=b.replace(new RegExp(c,"gi"),"<strong>$&</strong>")):d=b,a.trustAsHtml(d)}}]).filter("oiMultiselectAscSort",function(){function a(a,b,c){var d,e,f=[],g=[],h=[];if(b){for(d=0;d<a.length;d++)c(a[d]).match(new RegExp(b,"i"))&&f.push(a[d]);for(d=0;d<f.length;d++)c(f[d]).match(new RegExp("^"+b,"i"))?g.push(f[d]):h.push(f[d]);e=g.concat(h)}else e=[].concat(a);return e}return a});